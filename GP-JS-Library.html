<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <!-- Link to custom CSS -->
  <link rel="stylesheet" href="style.css">

  <!-- JQUERY -->
  <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

  <!-- Google Places JS Library -->
  <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAXPJDWXhzlAY0N8mMUcgFJ6yNSEd0vMg8&libraries=places"></script>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

  <title>GP JS Library Test</title>
</head>
<body>

  <div id="map" style="width:800px; height:800px;">
  </div>

  <script>
  //GOOGLE PLACES JS LIBRARY
  let map;
  let service;
  let infowindow;
  let marker;
  let name;
  let rating;
  let website;
  let phone;
  let address;
  let review;
  let coords;
  let photo;

  function initialize() {
    var mapCenter = new google.maps.LatLng(33.689060,-78.886694);

    map = new google.maps.Map(document.getElementById('map'), {
      center: mapCenter,
      zoom: 13
      });

    var request = {
      query: 'surf lessons in myrtle beach south carolina'
    };

    service = new google.maps.places.PlacesService(map);
    service.textSearch(request, callback);
  }

  //Gets the place_ids relevant to the query above. Uses that to get the place details.
  function callback(results, status) {
    if (status == google.maps.places.PlacesServiceStatus.OK) {
      for (var i = 0; i < results.length; i++) {
        place = results[i];
        //Log each place that got returned from the API
        // console.log('place', i, place);
        //Define the createMarker function so that markers get placed on the map
        // createMarker(results[i]);

        //Request the details of each place
        var detailsRequest = {
          placeId: place.place_id,
          fields: ['photo', 'website','formatted_phone_number', 'formatted_address', 'review', 'rating', 'name', 'geometry']
        };

        service = new google.maps.places.PlacesService(map);
        service.getDetails(detailsRequest, callback);

        function callback(placeDetails, status) {
          if (status == google.maps.places.PlacesServiceStatus.OK) {
            //Check if place has more than one review and greater than 3 star rating as a quality check before putting on Surf Trip List
            if (placeDetails.reviews !== undefined && placeDetails.reviews.length > 1 && placeDetails.rating !== undefined && placeDetails.rating > 3) {
              //Check if .gov is in the website URL. If it's not (indexOf = -1) then we can use it.
              if (placeDetails.website !== undefined && placeDetails.website.indexOf(".gov") == -1) {
                console.log(placeDetails);
                console.log(placeDetails.name);
                name = placeDetails.name;
                rating = placeDetails.rating;
                website = placeDetails.website;
                phone = placeDetails.formatted_phone_number;
                address = placeDetails.formatted_address;
                //Gets the most recent review.
                review = placeDetails.reviews[0].text;
                coords = {lat: placeDetails.geometry.location.lat(), lng: placeDetails.geometry.location.lng()}
                if (placeDetails.photos !== undefined) {
                  photo = placeDetails.photos[0].getUrl({'maxWidth': 400, 'maxHeight': 275});
                } else {
                  photo = "lesson-images/surf-lesson."
                }
                //Sets the surfboard rental markers on the map
                function addSurfboardRentalMarker(props, map) {
                    marker = new google.maps.Marker({
                      position: coords,
                      map: map,
                      icon: 'icon-images/boardRental.png'
                    });
                   //Creates the marker info window
                    infowindow = new google.maps.InfoWindow({
                      // maxWidth: NEED TO SET,
                      // maxWidth: NEED TO SET,
                    });

                    marker.addListener('click', function(){
                      //Opens the marker infowindow
                      infowindow.setContent ('<div id="iwcontent"><h4>' + placeDetails.name + "</h4><br>" + "<img src='" + placeDetails.photos[0].getUrl({'maxWidth': 400, 'maxHeight': 150}) + "'>" + "<p>üìû" + placeDetails.formatted_phone_number + "<br>üìç" + placeDetails.formatted_address + "<br>üíñ" + placeDetails.rating + "</p>" + "</div>");
                      infowindow.open(map, this);
                      google.maps.event.addListener(map, "click", function(event){
                        //Closes the marker infowindow
                        infowindow.close();
                      });
                    });
                }//End of addSurfboardRentalMarker
                addSurfboardRentalMarker(marker, map);
              }
            }
            // createMarker(place);
          }
        }
      }
    } else {
      //Handle this error if there is a problem
      console.error("Error in callback", status);
    }
  } //End GP Library callback

  initialize();

  </script>

  <!-- Optional JavaScript -->
  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <!-- <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

</body>

</html>
